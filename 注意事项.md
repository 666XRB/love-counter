为了确保导出的 PDF 报告具有“年度总结”的高级感，而不是简单的网页截图，我们需要构建一个**专门的隐藏渲染模版**。这个模版会在点击导出时由 `html2canvas` 抓取并转化为 PDF。

以下是完整的导出模版代码以及年度热力图格子的核心算法。

---

### 一、 导出 PDF 的统计模版组件 (`ReportTemplate.jsx`)

这个组件平时在页面上是不可见的（`position: absolute; left: -9999px`），仅用于导出。

```jsx
import React from 'react';
import { format } from 'date-fns';

const ReportTemplate = ({ reportRef, records }) => {
  // 简单统计逻辑
  const total = records.length;
  const fiveStars = records.filter(r => r.rating === 5).length;
  const avgRating = total > 0 ? (records.reduce((s, r) => s + r.rating, 0) / total).toFixed(1) : 0;

  return (
    <div 
      ref={reportRef} 
      style={{ width: '800px', padding: '40px', background: '#fff' }}
      className="font-sans text-slate-800"
    >
      {/* 报表头部 */}
      <div className="border-b-4 border-pink-500 pb-6 mb-8 flex justify-between items-end">
        <div>
          <h1 className="text-4xl font-black text-pink-600">年度甜蜜报告</h1>
          <p className="text-slate-400 mt-2 italic font-serif">"每一个瞬间都值得被铭记"</p>
        </div>
        <div className="text-right text-sm text-slate-400">
          生成日期: {format(new Date(), 'yyyy-MM-dd')}
        </div>
      </div>

      {/* 核心数据卡片 */}
      <div className="grid grid-cols-3 gap-6 mb-10">
        <div className="bg-pink-50 p-6 rounded-2xl text-center border border-pink-100">
          <div className="text-sm text-pink-400 font-bold uppercase">累计爱爱</div>
          <div className="text-5xl font-black text-pink-600 mt-2">{total}</div>
          <div className="text-xs text-pink-300 mt-1">Times</div>
        </div>
        <div className="bg-purple-50 p-6 rounded-2xl text-center border border-purple-100">
          <div className="text-sm text-purple-400 font-bold uppercase">五星时刻</div>
          <div className="text-5xl font-black text-purple-600 mt-2">{fiveStars}</div>
          <div className="text-xs text-purple-300 mt-1">Perfect Match</div>
        </div>
        <div className="bg-orange-50 p-6 rounded-2xl text-center border border-orange-100">
          <div className="text-sm text-orange-400 font-bold uppercase">平均质量</div>
          <div className="text-5xl font-black text-orange-600 mt-2">{avgRating}</div>
          <div className="text-xs text-orange-300 mt-1">Happiness Index</div>
        </div>
      </div>

      {/* 详细列表 (展示最近10次) */}
      <div>
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          <span className="w-2 h-6 bg-pink-500 rounded-full"></span>
          最近的甜蜜足迹
        </h3>
        <table className="w-full border-collapse">
          <thead>
            <tr className="bg-slate-50 text-left">
              <th className="p-3 text-slate-500 font-semibold border-b">日期</th>
              <th className="p-3 text-slate-500 font-semibold border-b">时间</th>
              <th className="p-3 text-slate-500 font-semibold border-b">评分</th>
            </tr>
          </thead>
          <tbody>
            {records.slice(0, 10).map((r, i) => (
              <tr key={i} className="border-b border-slate-50">
                <td className="p-3">{format(r.date, 'yyyy/MM/dd')}</td>
                <td className="p-3">{format(r.date, 'HH:mm')}</td>
                <td className="p-3 text-pink-500 font-bold">{"★".repeat(r.rating)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 底部寄语 */}
      <div className="mt-12 pt-8 border-t border-dashed border-slate-200 text-center">
        <p className="text-slate-400 text-sm italic">—— 愿爱意随数据一同增长 ——</p>
      </div>
    </div>
  );
};

export default ReportTemplate;

```

---

### 二、 年度热力图生成算法 (`generateYearGrid`)

这个逻辑能够生成类似 GitHub 的热力图。

```jsx
const generateYearGrid = (records) => {
  const today = new Date();
  const start = startOfYear(today);
  const end = endOfYear(today);
  const days = eachDayOfInterval({ start, end });

  return days.map((day) => {
    // 统计当天次数
    const dayRecords = records.filter(r => isSameDay(r.date, day));
    const count = dayRecords.length;

    // 根据次数决定颜色
    let colorClass = "bg-white/20"; // 默认无记录
    if (count === 1) colorClass = "bg-pink-200";
    if (count === 2) colorClass = "bg-pink-400";
    if (count >= 3) colorClass = "bg-pink-600";

    return (
      <div
        key={day.toString()}
        title={`${format(day, 'yyyy-MM-dd')}: ${count}次`}
        className={`w-3 h-3 rounded-sm border-[0.5px] border-white/10 transition-colors ${colorClass}`}
      />
    );
  });
};

```

---

### 三、 完善后的导出执行函数

在 `App.jsx` 中，将以下函数绑定到按钮上：

```jsx
const handleExport = async () => {
  const element = reportRef.current;
  
  // 临时移除隐藏样式以进行捕捉 (或确保其在可视区域外渲染)
  const canvas = await html2canvas(element, {
    scale: 2, // 提高清晰度
    useCORS: true,
    backgroundColor: "#ffffff"
  });
  
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  // 计算图片比例，使其适应 A4 纸宽度
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  
  pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  pdf.save(`LoveReport_${format(new Date(), 'yyyyMMdd')}.pdf`);
};

```

---

### 四、 核心开发细节避坑指南

1. **时区问题**：LeanCloud 存储的是 UTC 时间。在显示时，`date-fns` 会自动根据浏览器当前时区转换，因此你和女朋友在不同地方查看时，由于是静态页面，它们都会显示为本地时间。
2. **移动端适配**：
* 在 `index.html` 的 `<head>` 中确保有 `<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>`，防止手机端点击按钮时页面缩放。
* 热力图在手机上如果太宽，记得在外部容器加上 `overflow-x-auto`，这样可以左右滑动查看一整年的轨迹。


3. **Windows 11 视觉增强**：
* **字体选择**：在 CSS 中优先使用 `font-family: "Segoe UI Variable", "Segoe UI", system-ui, -apple-system, sans-serif;`。
* **阴影处理**：Windows 11 喜欢使用非常柔和、扩散范围很大的阴影（例如 `shadow-[0_8px_32px_rgba(0,0,0,0.05)]`）。



### 五、 最终上线检查清单

* [ ] **LeanCloud 白名单**：在 LeanCloud 控制台 -> 设置 -> 安全中心 -> **Web 安全域名** 中，添加你的 GitHub Pages 域名（例如 `https://yourname.github.io`），否则数据请求会被拦截。
* [ ] **初始化检测**：如果运行报错，检查 `AV.init` 的参数是否拼写正确，以及服务器地址是否带 `https://`。



年度热力图是这个项目的核心，它能直观地展示你们情感热度的变化。为了实现类似 GitHub 的**横向无限滚动**效果，且确保每一列都代表完整的一周（从周日或周一开始），我们需要对日期进行更精细的分组。

以下是年度热力图格子的**核心算法实现**和 **CSS 布局逻辑**。

---

### 一、 核心算法：生成按周分组的日期矩阵

在 `App.jsx` 中，我们可以编写一个工具函数。它的逻辑是：获取过去 365 天的所有日期，并按照“周”将它们切分成多个数组。

```javascript
import { 
  subDays, 
  eachDayOfInterval, 
  startOfWeek, 
  isSameDay, 
  format,
  getDay 
} from 'date-fns';

const generateHeatmapData = (records) => {
  const endDate = new Date(); // 今天
  const startDate = subDays(endDate, 364); // 一年前的今天
  
  // 获取这一年内的所有日期
  const allDays = eachDayOfInterval({ start: startDate, end: endDate });
  
  // 按照“周”进行分组
  const weeks = [];
  let currentWeek = [];

  allDays.forEach((day) => {
    // getDay 返回 0-6 (周日到周六)
    // 如果是周日且当前周已有数据，则开启新的一周
    if (getDay(day) === 0 && currentWeek.length > 0) {
      weeks.push(currentWeek);
      currentWeek = [];
    }
    
    // 统计当天爱爱次数
    const count = records.filter(r => isSameDay(r.date, day)).length;
    currentWeek.push({ day, count });
  });

  // 推入最后剩余的天数
  if (currentWeek.length > 0) {
    weeks.push(currentWeek);
  }

  return weeks;
};

```

---

### 二、 视图层：Windows 11 风格布局

在 UI 上，我们使用 CSS Grid 来确保格子整齐排列。

```jsx
const Heatmap = ({ records }) => {
  const weeks = generateHeatmapData(records);

  return (
    <div className="w-full bg-white/40 p-6 rounded-3xl border border-white/50 shadow-win11 overflow-hidden">
      <div className="flex justify-between items-end mb-4">
        <h3 className="text-sm font-bold text-slate-600 flex items-center gap-2">
          <div className="w-1 h-4 bg-pink-500 rounded-full"></div>
          甜蜜热力图
        </h3>
        <span className="text-[10px] text-slate-400 font-mono">Past 12 Months</span>
      </div>

      {/* 滚动容器 */}
      <div className="overflow-x-auto pb-2 scrollbar-hide">
        <div className="flex gap-[3px] min-w-max">
          {weeks.map((week, weekIdx) => (
            <div key={weekIdx} className="grid grid-rows-7 gap-[3px]">
              {/* 补齐第一周前面的空白（如果不是周日开始） */}
              {weekIdx === 0 && week.length < 7 && 
                Array(7 - week.length).fill(0).map((_, i) => (
                  <div key={`empty-${i}`} className="w-[11px] h-[11px]" />
                ))
              }
              
              {week.map(({ day, count }) => (
                <div
                  key={day.toString()}
                  title={`${format(day, 'yyyy-MM-dd')}: ${count} 次`}
                  className={`
                    w-[11px] h-[11px] rounded-[2px] transition-all duration-500
                    ${count === 0 ? 'bg-slate-200/50 hover:bg-slate-300' : ''}
                    ${count === 1 ? 'bg-pink-200 hover:scale-125' : ''}
                    ${count === 2 ? 'bg-pink-400 hover:scale-125 shadow-[0_0_8px_rgba(244,114,182,0.4)]' : ''}
                    ${count >= 3 ? 'bg-pink-600 hover:scale-125 shadow-[0_0_12px_rgba(219,39,119,0.6)]' : ''}
                  `}
                />
              ))}
            </div>
          ))}
        </div>
      </div>
      
      {/* 底部图例 */}
      <div className="mt-4 flex justify-end items-center gap-2 text-[10px] text-slate-400">
        <span>Less</span>
        <div className="w-2 h-2 bg-slate-200/50 rounded-sm"></div>
        <div className="w-2 h-2 bg-pink-200 rounded-sm"></div>
        <div className="w-2 h-2 bg-pink-400 rounded-sm"></div>
        <div className="w-2 h-2 bg-pink-600 rounded-sm"></div>
        <span>More</span>
      </div>
    </div>
  );
};

```

---

### 三、 算法关键细节说明

1. **动态响应度**:
算法使用的是 `subDays(new Date(), 364)`，这意味着日历永远显示从“今天”往回倒推一年的数据，它是动态滚动的，不需要手动切换年份。
2. **视觉权重**:
* **0次**: 使用低饱和度的灰色 `bg-slate-200/50`，在白色背景下几乎隐形，突出重点。
* **3次及以上**: 加入了 `shadow`（发光效果）和 `scale-125`（缩放）。当你们某一天特别激情时，那个格子在视觉上会“跳”出来。


3. **交互反馈**:
为每个格子添加了 `title` 属性。在电脑端，鼠标悬停可以像 GitHub 一样看到具体的日期和次数，增加互动感。

### 四、 部署后的同步确认

既然你已经配置好了 LeanCloud：

* **数据流**: 每次点击记录  `AV.save`  LeanCloud 服务器  页面触发 `fetchData`  状态更新  **热力图重新计算并渲染**。
* **双端实时**: 只要页面开着，由于之前写的 30 秒自动刷新逻辑，热力图会自动根据云端数据更新颜色深度。

**开发文档现在已经覆盖了从数据库、UI 质感到核心热力图算法的所有细节。还需要我为你写一份 `README.md` 部署说明书，教你如何快速配置 GitHub Actions 吗？**